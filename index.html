<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
  <!--[if IE 8]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/ie8/0.2.2/ie8.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.1.1/es5-shim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.1.1/es5-sham.js"></script>
  <![endif]-->
</head>
<body>

<div id="link">
  You're looking at DOM<br>
  version of <a href="https://dbmonster.firebaseapp.com/">DBMonster</a>.
</div>

<div id="body">
</div>

<script src="data.js"></script>

<script type="text/javascript">

  var requestAnimationFrame = requestAnimationFrame || setTimeout;

  var rootNode, updates;

  // shortcut for document.createElement
  function create(what) {
    return document.createElement(what);
  }

  // recycled function for all updates
  function updateInfo(info, i) {
    this[i](info);
  }

  // main logic
  function update() {

    // we receive data
    var dbs = getData();

    // we create the table once
    if(rootNode == null) {

      rootNode = create('table');
      rootNode.className = 'table table-striped latest-data';
      rootNode = rootNode.appendChild(create('tbody'));

      // per each data ...
      updates = dbs.map(
        function (db) {
          var
            // create the row
            tr = rootNode.appendChild(create('tr')),
            // create all other fields like a static template would do
            dbName = tr.appendChild(create('td')),
            queryCount = tr.appendChild(create('td')),
            countInfo = queryCount.appendChild(create('span')),
            // map updates for top five queries, pass the row
            topFiveQueries = db.topFiveQueries.map(this, tr)
          ;
          // setup nodes
          dbName.className = 'dbname';
          queryCount.className = 'query-count';
          // return a function that will update all of the above
          return function (db) {
            // we update only what we need
            // we use native DOM methods
            tr.setAttribute('key', db.name);
            // we trust automatic HTML escape via native DOM
            dbName.textContent = db.name;
            countInfo.className = getCountClassName(db);
            countInfo.textContent = db.queries.length;
            // we update top five too
            db.topFiveQueries.forEach(updateInfo, topFiveQueries);
          };
        },
        // recycled function, creates info per each top-five query
        function (query) {
          var
            // the td with its fields
            td = this.appendChild(create('td')),
            elapsed = td.appendChild(create('span')),
            popoverLeft = td.appendChild(create('div')),
            popoverContent = popoverLeft.appendChild(create('div')),
            arrow = popoverLeft.appendChild(create('div'))
          ;
          // classes setup
          elapsed.className = 'foo';
          popoverLeft.className = 'popover left';
          popoverContent.className = 'popover-content';
          arrow.className = 'arrow';
          // we return the function that will update the necessary
          return function (query) {
            td.className = 'Query ' + elapsedClassName(query.elapsed);
            elapsed.textContent = formatElapsed(query.elapsed);
            popoverContent.textContent = query.query;
          };
        }
      );

      // we append the table once
      document.getElementById('body').appendChild(rootNode.parentNode);

    }

    // we update all rows
    dbs.forEach(updateInfo, updates);

    // we ask to perform the same ASAP
    requestAnimationFrame(update);
  }

  requestAnimationFrame(update);

</script>

</body>
</html>